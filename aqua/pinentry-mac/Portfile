# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:filetype=tcl:et:sw=4:ts=4:sts=4

PortSystem              1.0
PortGroup               github 1.0
PortGroup               xcode 1.0
PortGroup               xcodeversion 1.0

categories              aqua security
license                 GPL-3+
maintainers             {ionic @Ionic}
platforms               macosx

description             Cocoa interface for the password entry software pinentry.
long_description        ${description} \
                        It is based on the upstream version of pinentry, adding a \
                        custom interface based on Cocoa for OS X look and feel.
homepage                https://github.com/GPGTools/pinentry-mac

if {${os.major} >= 12 && ${configure.build_arch} in "x86_64 arm64"} {
    github.setup        GPGTools pinentry-mac 0.9.4 v
    revision            1

    # Utilizes ARC which is x86_64/arm64-only. #45949
    supported_archs     x86_64 arm64
    installs_libs       no

    checksums           rmd160 b4023708d1320bd1b0ad5ce0dc35ec71fc68b33c \
                        sha256 73e649213e17dd46340f202453ed835166245b63f0cf2a78203d51d620b2742c \
                        size   284942


    patchfiles          patch-includes-quotes.diff \
                        patch-includes-quotes-2.diff \
                        patch-apple-silicon.diff

    patch.pre_args      -p1

    # This is a temporary kludge. The new Xcode build system fails to
    # destroot this for reasons that are poorly understood.
    # Remove this when a better fix is known.
    if {[vercmp ${xcodeversion} 10.0] >= 0} {
        destroot.pre_args   -UseNewBuildSystem=NO
    }

    # xcodeproject has been created with Xcode 5 which is only available on 10.8 and up.
    minimum_xcodeversions   {12 5.0}

    xcode.target            ${name}
    xcode.configuration     Release
} else {
    # legacy version for old Mac OS X
    github.setup        GPGTools pinentry-mac 0.8.1 v
    revision            0

    checksums           rmd160  3cbe052b88eb2ed1e0309c2716c8672958f6c82a \
                        sha256  43da01553740354f221eab69d9ba0843fac6d3a0455494342ab60e14425c6bed \
                        size    790277

    patch.pre_args      -p1
    patchfiles-append   0.8.1/no-arc.patch \
                        0.8.1/no-codesign-check.patch

    xcode.target        ${name}
    if {${os.major} > 10} {
        xcode.configuration Release
    } else {
        xcode.configuration "Release with ppc"
        patchfiles-append 0.8.1/no-lion-keychain.patch
    }
}

platform macosx {
    notes   "
             If you previously didn't have pinentry or gpg-agent installed\
             and ${name} has been installed as a dependency of gpg-agent\
             you don't need to do anything to use ${name}.

             If you want to switch to the GTK2, ncurses or Qt4 based pinentry\
             program, please install pinentry with the correct use flags and\
             follow the instructions below substituting the ${name} program\
             path with ${prefix}/bin/pinentry.


             If you previously had pinentry and gpg-agent installed and would\
             like to switch to ${name}, you will have to set\
             it as your pinentry program in \$HOME/.gnupg/gpg-agent.conf.

             Add the following line to the mentioned file:
             pinentry-program ${applications_dir}/${name}.app/Contents/MacOS/${name}


             Be sure to comment previous \"pinentry-program\" lines, for example:

             pinentry-program SAMPLE

             becomes

             #pinentry-program SAMPLE


             Afterwards, run
             killall -HUP gpg-agent

             or simply log out and back in again.
            "
}
